<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Demo</title>
    <link rel="icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9EF2B3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sensor Demo">
    <script type="module" src="https://unpkg.com/@material/web/all.js?module"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

<body data-theme="light">
    <div class="app-bar">
        <h1>Sensor Demo</h1>
        <div class="theme-switch-container">
            <md-icon>light_mode</md-icon>
            <md-switch id="themeSwitch"></md-switch>
            <md-icon>dark_mode</md-icon>
        </div>
    </div>

    <div class="app-container">
        <!-- #permissionButtonContainer ã¯å‰Šé™¤ -->

        <!-- Device Orientation Card -->
        <md-card>
            <div class="card-header">
                <md-icon>screen_rotation</md-icon>
                <h2>ãƒ‡ãƒã‚¤ã‚¹ã®å‘ã</h2>
            </div>
            <div class="card-content">
                <div class="cube-container">
                    <div class="cube" id="orientationCube">
                        <div class="cube__face cube__face--front">å‰</div>
                        <div class="cube__face cube__face--back">å¾Œ</div>
                        <div class="cube__face cube__face--right">å³</div>
                        <div class="cube__face cube__face--left">å·¦</div>
                        <div class="cube__face cube__face--top">ä¸Š</div>
                        <div class="cube__face cube__face--bottom">ä¸‹</div>
                    </div>
                </div>
                <p class="sensor-value"><strong>Alpha (Zè»¸):</strong> <span id="orient-alpha">-</span> Â°</p>
                <p class="sensor-value"><strong>Beta (Xè»¸):</strong> <span id="orient-beta">-</span> Â°</p>
                <p class="sensor-value"><strong>Gamma (Yè»¸):</strong> <span id="orient-gamma">-</span> Â°</p>
                <p class="status-text" id="orient-status">å¾…æ©Ÿä¸­...</p>
            </div>
        </md-card>

        <!-- Accelerometer Card -->
        <md-card>
            <div class="card-header">
                <md-icon>vibration</md-icon>
                <h2>åŠ é€Ÿåº¦ (é‡åŠ›å«ã‚€)</h2>
            </div>
            <div class="card-content">
                <div class="bars-container">
                    <div class="bar" id="accel-bar-x"><span class="bar-label">X</span></div>
                    <div class="bar" id="accel-bar-y"><span class="bar-label">Y</span></div>
                    <div class="bar" id="accel-bar-z"><span class="bar-label">Z</span></div>
                </div>
                <p class="sensor-value"><strong>X:</strong> <span id="accel-x">-</span> m/sÂ²</p>
                <p class="sensor-value"><strong>Y:</strong> <span id="accel-y">-</span> m/sÂ²</p>
                <p class="sensor-value"><strong>Z:</strong> <span id="accel-z">-</span> m/sÂ²</p>
                <p class="status-text" id="accel-status">å¾…æ©Ÿä¸­...</p>
            </div>
        </md-card>

        <!-- Gyroscope Card -->
        <md-card>
            <div class="card-header">
                <md-icon>explore</md-icon>
                <h2>ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ— (å›è»¢é€Ÿåº¦)</h2>
            </div>
            <div class="card-content">
                <p class="sensor-value"><strong>Alpha (Zè»¸):</strong> <span id="gyro-alpha">-</span> Â°/s</p>
                <p class="sensor-value"><strong>Beta (Xè»¸):</strong> <span id="gyro-beta">-</span> Â°/s</p>
                <p class="sensor-value"><strong>Gamma (Yè»¸):</strong> <span id="gyro-gamma">-</span> Â°/s</p>
                <p class="status-text" id="gyro-status">å¾…æ©Ÿä¸­...</p>
            </div>
        </md-card>

        <!-- Light Sensor Card -->
        <md-card>
            <div class="card-header">
                <md-icon>lightbulb</md-icon>
                <h2>å…‰ã‚»ãƒ³ã‚µãƒ¼</h2>
            </div>
            <div class="card-content">
                <div class="light-viz">
                    <md-icon id="light-icon-sun" style="display:none;">wb_sunny</md-icon>
                    <md-icon id="light-icon-moon" style="display:none;">nightlight_round</md-icon>
                </div>
                <p class="sensor-value"><strong>æ˜ã‚‹ã•:</strong> <span id="light-value">-</span> lux</p>
                <p class="status-text" id="light-status">å¾…æ©Ÿä¸­...</p>
            </div>
        </md-card>

        <p style="font-size: 0.8em; text-align: center; margin-top: 20px; margin-bottom: 80px; /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ãƒãƒ¼ã¨ã®ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */ color: var(--md-sys-color-on-surface-variant);">
            æ³¨æ„: ã‚»ãƒ³ã‚µãƒ¼ã®åˆ©ç”¨ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã¯ä¸€éƒ¨ã‚»ãƒ³ã‚µãƒ¼ãŒåˆ©ç”¨ã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è¨˜éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
        </p>
    </div>

    <!-- New Icon Button Bar for Recording -->
    <div class="icon-button-bar">
        <div class="recording-status-bar">
            <p class="status-text" id="recordingStatus">å¾…æ©Ÿä¸­...</p>
        </div>
        <div class="icon-button-controls">
            <md-icon-button id="sensorPermissionIconButton" aria-label="ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯">
                <md-icon>lock</md-icon>
            </md-icon-button>
            <md-icon-button id="startRecordingIconButton" aria-label="è¨˜éŒ²é–‹å§‹" disabled>
                <md-icon>play_arrow</md-icon>
            </md-icon-button>
            <md-icon-button id="stopRecordingIconButton" aria-label="è¨˜éŒ²åœæ­¢" disabled>
                <md-icon>stop</md-icon>
            </md-icon-button>
            <md-icon-button id="downloadCSVIconButton" aria-label="CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" disabled>
                <md-icon>download</md-icon>
            </md-icon-button>
        </div>
    </div>

    <script type="module">
        // MWCã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‚ç…§

        // DOM Elements
        const body = document.body;
        const themeSwitch = document.getElementById('themeSwitch');

        // Recording Elements - Updated to icon buttons
        const sensorPermissionIconButton = document.getElementById('sensorPermissionIconButton');
        const startRecordingIconButton = document.getElementById('startRecordingIconButton');
        const stopRecordingIconButton = document.getElementById('stopRecordingIconButton');
        const downloadCSVIconButton = document.getElementById('downloadCSVIconButton');
        const recordingStatusEl = document.getElementById('recordingStatus');

        // Orientation
        const orientationCube = document.getElementById('orientationCube');
        const orientAlphaEl = document.getElementById('orient-alpha');
        const orientBetaEl = document.getElementById('orient-beta');
        const orientGammaEl = document.getElementById('orient-gamma');
        const orientStatusEl = document.getElementById('orient-status');

        // Accelerometer
        const accelXEl = document.getElementById('accel-x');
        const accelYEl = document.getElementById('accel-y');
        const accelZEl = document.getElementById('accel-z');
        const accelStatusEl = document.getElementById('accel-status');
        const accelBarX = document.getElementById('accel-bar-x');
        const accelBarY = document.getElementById('accel-bar-y');
        const accelBarZ = document.getElementById('accel-bar-z');
        const BAR_MAX_ACCEL = 20;

        // Gyroscope
        const gyroAlphaEl = document.getElementById('gyro-alpha');
        const gyroBetaEl = document.getElementById('gyro-beta');
        const gyroGammaEl = document.getElementById('gyro-gamma');
        const gyroStatusEl = document.getElementById('gyro-status');

        // Light Sensor
        const lightValueEl = document.getElementById('light-value');
        const lightStatusEl = document.getElementById('light-status');
        const lightIconSun = document.getElementById('light-icon-sun');
        const lightIconMoon = document.getElementById('light-icon-moon');

        // --- Recording Variables ---
        let isRecording = false;
        let recordedData = [];
        let recordingIntervalId = null;
        const RECORDING_INTERVAL_MS = 100;
        let currentSensorValues = {
            timestamp: null,
            accelX: null, accelY: null, accelZ: null,
            orientAlpha: null, orientBeta: null, orientGamma: null,
            gyroAlpha: null, gyroBeta: null, gyroGamma: null,
            illuminance: null
        };

        // --- Theme Switch Logic ---
        function applyTheme(theme) {
            body.dataset.theme = theme;
            localStorage.setItem('theme', theme);
            if (themeSwitch) {
                themeSwitch.selected = (theme === 'dark');
                themeSwitch.ariaLabel = theme === 'dark' ? 'ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆ';
            }
        }
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const savedTheme = localStorage.getItem('theme');
        const currentTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
        applyTheme(currentTheme);
        prefersDarkScheme.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });
        if (themeSwitch) {
            themeSwitch.addEventListener('change', () => {
                applyTheme(themeSwitch.selected ? 'dark' : 'light');
            });
        }

        // --- Sensor Permission and Initialization ---
        let motionPermissionGranted = false;
        let orientationPermissionGranted = false;
        let sensorsInitialized = false;
        let anySensorSupported = false; // ã„ãšã‚Œã‹ã®ã‚»ãƒ³ã‚µãƒ¼ãŒå®Ÿéš›ã«åˆ©ç”¨å¯èƒ½ã‹

        const needsExplicitPermission = (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') ||
                                    (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function');

        function updateRecordingButtonState() {
            if (!startRecordingIconButton) return; // DOMèª­ã¿è¾¼ã¿å‰ã¯å®Ÿè¡Œã—ãªã„

            const permissionIconEl = sensorPermissionIconButton ? sensorPermissionIconButton.querySelector('md-icon') : null;
            const mainPermissionsGranted = motionPermissionGranted && orientationPermissionGranted;

            if (needsExplicitPermission && !mainPermissionsGranted && sensorPermissionIconButton) {
                sensorPermissionIconButton.style.display = 'inline-flex';
                sensorPermissionIconButton.disabled = false;
                if (permissionIconEl) permissionIconEl.textContent = 'lock';
            } else if (sensorPermissionIconButton) {
                sensorPermissionIconButton.style.display = 'inline-flex'; // è¡¨ç¤ºã¯ç¶­æŒã—ã€çŠ¶æ…‹ã‚’ç¤ºã™
                sensorPermissionIconButton.disabled = true; // å½¹å‰²ã‚’çµ‚ãˆãŸã‚‰ç„¡åŠ¹åŒ–
                if (permissionIconEl) permissionIconEl.textContent = (mainPermissionsGranted || anySensorSupported) ? 'lock_open' : 'lock';
                 // ã‚‚ã—å®Œå…¨ã«ä¸è¦ãªã‚‰ style.display = 'none' ã‚‚æ¤œè¨
            }


            const sensorsReadyForRecording = sensorsInitialized && (anySensorSupported || motionPermissionGranted || orientationPermissionGranted);

            startRecordingIconButton.disabled = !sensorsReadyForRecording || isRecording;
            stopRecordingIconButton.disabled = !sensorsReadyForRecording || !isRecording;
            downloadCSVIconButton.disabled = !sensorsReadyForRecording || isRecording || recordedData.length === 0;

            if (isRecording) {
                recordingStatusEl.textContent = `è¨˜éŒ²ä¸­... (${recordedData.length}ä»¶)`;
            } else if (recordedData.length > 0) {
                recordingStatusEl.textContent = `è¨˜éŒ²åœæ­¢ã€‚${recordedData.length}ä»¶ã€‚CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯ã€‚`;
            } else if (sensorsReadyForRecording) {
                recordingStatusEl.textContent = "ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–ä¸­ã€‚è¨˜éŒ²ã‚’é–‹å§‹ã§ãã¾ã™ã€‚";
            } else if (sensorsInitialized && !anySensorSupported && !motionPermissionGranted && !orientationPermissionGranted) {
                recordingStatusEl.textContent = "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒ³ã‚µãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
            } else if (needsExplicitPermission && !mainPermissionsGranted) {
                recordingStatusEl.textContent = "å·¦ã®ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
            } else {
                 recordingStatusEl.textContent = "ã‚»ãƒ³ã‚µãƒ¼æº–å‚™ä¸­ã¾ãŸã¯åˆ©ç”¨ä¸å¯ã€‚";
            }
        }


        function initializeSensors() {
            if (sensorsInitialized) return;
            // anySensorSupported ã¯å„ã‚»ãƒ³ã‚µãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã§ true ã«è¨­å®šã•ã‚Œã‚‹

            if (motionPermissionGranted) {
                window.addEventListener('devicemotion', handleMotionEvent, { passive: true });
                accelStatusEl.textContent = "ç›£è¦–ä¸­...";
                gyroStatusEl.textContent = "ç›£è¦–ä¸­...";
                // anySensorSupported ã¯ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡æ™‚ã«è¨­å®š
            } else if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission !== 'function') { // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³APIãªã—ç’°å¢ƒ
                window.addEventListener('devicemotion', handleMotionEvent, { passive: true });
                accelStatusEl.textContent = "ç›£è¦–ä¸­...";
                gyroStatusEl.textContent = "ç›£è¦–ä¸­...";
                motionPermissionGranted = true; // æš—é»™çš„ã«è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã¨ã¿ãªã™
            } else if (!window.DeviceMotionEvent) {
                accelStatusEl.textContent = 'åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                accelStatusEl.classList.add('not-supported');
                gyroStatusEl.textContent = 'ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                gyroStatusEl.classList.add('not-supported');
            }

            if (orientationPermissionGranted) {
                window.addEventListener('deviceorientation', handleOrientationEvent, { passive: true });
                orientStatusEl.textContent = "ç›£è¦–ä¸­...";
            } else if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission !== 'function') { // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³APIãªã—ç’°å¢ƒ
                window.addEventListener('deviceorientation', handleOrientationEvent, { passive: true });
                orientStatusEl.textContent = "ç›£è¦–ä¸­...";
                orientationPermissionGranted = true; // æš—é»™çš„ã«è¨±å¯
            } else if(!window.DeviceOrientationEvent) {
                orientStatusEl.textContent = 'å‘ãã‚»ãƒ³ã‚µãƒ¼ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                orientStatusEl.classList.add('not-supported');
            }

            initializeLightSensor(); // å…‰ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–ã‚‚è¡Œã†

            sensorsInitialized = true;
            updateRecordingButtonState();
        }

        function requestSensorPermissions() {
            const promises = [];
            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function' && !motionPermissionGranted) {
                promises.push(
                    DeviceMotionEvent.requestPermission().then(state => {
                        if (state === 'granted') {
                            motionPermissionGranted = true;
                        } else {
                            accelStatusEl.textContent = 'åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                            accelStatusEl.classList.add('error');
                            gyroStatusEl.textContent = 'ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                            gyroStatusEl.classList.add('error');
                        }
                    }).catch(err => {
                        console.error("DeviceMotionEvent permission error:", err);
                        accelStatusEl.textContent = `åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼`; accelStatusEl.classList.add('error');
                        gyroStatusEl.textContent = `ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼`; gyroStatusEl.classList.add('error');
                    })
                );
            }

            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function' && !orientationPermissionGranted) {
                promises.push(
                    DeviceOrientationEvent.requestPermission().then(state => {
                        if (state === 'granted') {
                            orientationPermissionGranted = true;
                        } else {
                            orientStatusEl.textContent = 'å‘ãã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                            orientStatusEl.classList.add('error');
                        }
                    }).catch(err => {
                        console.error("DeviceOrientationEvent permission error:", err);
                        orientStatusEl.textContent = `å‘ãã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼`; orientStatusEl.classList.add('error');
                    })
                );
            }

            if (promises.length > 0) {
                Promise.allSettled(promises).then(() => {
                    initializeSensors();
                });
            } else {
                // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦æ±‚ãŒä¸è¦ã ã£ãŸã‹ã€æ—¢ã«è¨±å¯æ¸ˆã¿ã®å ´åˆ
                initializeSensors();
            }
        }

        if (needsExplicitPermission) {
            if (sensorPermissionIconButton) {
                sensorPermissionIconButton.addEventListener('click', requestSensorPermissions, { once: true });
            }
            // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            accelStatusEl.textContent = "ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨±å¯";
            gyroStatusEl.textContent = "ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨±å¯";
            orientStatusEl.textContent = "ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨±å¯";
        } else {
            if (sensorPermissionIconButton) sensorPermissionIconButton.style.display = 'none';
            requestSensorPermissions(); // ç›´æ¥ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
        }

        // --- Sensor Event Handlers ---
        function handleMotionEvent(event) {
            if (!motionPermissionGranted && !(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission !== 'function')) return;
            anySensorSupported = true; // DeviceMotion ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒæ¥å§‹ã‚ãŸ

            if (event.accelerationIncludingGravity) {
                const { x, y, z } = event.accelerationIncludingGravity;
                currentSensorValues.accelX = x; currentSensorValues.accelY = y; currentSensorValues.accelZ = z;
                accelXEl.textContent = x ? x.toFixed(2) : '-';
                accelYEl.textContent = y ? y.toFixed(2) : '-';
                accelZEl.textContent = z ? z.toFixed(2) : '-';
                requestAnimationFrame(() => {
                    accelBarX.style.height = `${Math.min(100, (Math.abs(x || 0) / BAR_MAX_ACCEL) * 100)}%`;
                    accelBarY.style.height = `${Math.min(100, (Math.abs(y || 0) / BAR_MAX_ACCEL) * 100)}%`;
                    accelBarZ.style.height = `${Math.min(100, (Math.abs(z || 0) / BAR_MAX_ACCEL) * 100)}%`;
                });
                if (accelStatusEl.textContent !== "ç›£è¦–ä¸­...") accelStatusEl.textContent = "ç›£è¦–ä¸­...";
            } else { /* ... */ }

            if (event.rotationRate) {
                const { alpha, beta, gamma } = event.rotationRate;
                currentSensorValues.gyroAlpha = alpha; currentSensorValues.gyroBeta = beta; currentSensorValues.gyroGamma = gamma;
                gyroAlphaEl.textContent = alpha ? alpha.toFixed(2) : '-';
                gyroBetaEl.textContent = beta ? beta.toFixed(2) : '-';
                gyroGammaEl.textContent = gamma ? gamma.toFixed(2) : '-';
                if (gyroStatusEl.textContent !== "ç›£è¦–ä¸­...") gyroStatusEl.textContent = "ç›£è¦–ä¸­...";
            } else { /* ... */ }
            if (sensorsInitialized) updateRecordingButtonState(); // çŠ¶æ…‹å¤‰åŒ–ã®å¯èƒ½æ€§
        }

        function handleOrientationEvent(event) {
            if (!orientationPermissionGranted && !(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission !== 'function')) return;
            anySensorSupported = true; // DeviceOrientation ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒæ¥å§‹ã‚ãŸ

            const { alpha, beta, gamma } = event;
            currentSensorValues.orientAlpha = alpha; currentSensorValues.orientBeta = beta; currentSensorValues.orientGamma = gamma;
            orientAlphaEl.textContent = alpha ? alpha.toFixed(1) : '-';
            orientBetaEl.textContent = beta ? beta.toFixed(1) : '-';
            orientGammaEl.textContent = gamma ? gamma.toFixed(1) : '-';
            if (beta !== null && gamma !== null && alpha !== null) {
                requestAnimationFrame(() => {
                    orientationCube.style.transform = `rotateX(${beta.toFixed(1)}deg) rotateY(${gamma.toFixed(1)}deg) rotateZ(${alpha.toFixed(1)}deg)`;
                });
            }
            if (orientStatusEl.textContent !== "ç›£è¦–ä¸­...") orientStatusEl.textContent = "ç›£è¦–ä¸­...";
            if (sensorsInitialized) updateRecordingButtonState(); // çŠ¶æ…‹å¤‰åŒ–ã®å¯èƒ½æ€§
        }

        function initializeLightSensor() {
            if (!('AmbientLightSensor' in window)) {
                lightStatusEl.textContent = 'å…‰ã‚»ãƒ³ã‚µãƒ¼ API ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                lightStatusEl.classList.add('not-supported');
                currentSensorValues.illuminance = null;
                if (sensorsInitialized) updateRecordingButtonState();
                return;
            }
            lightStatusEl.textContent = "ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            const startSensor = () => {
                try {
                    const sensor = new AmbientLightSensor({ frequency: 1 });
                    sensor.addEventListener('reading', () => {
                        anySensorSupported = true; // å…‰ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒæ¥å§‹ã‚ãŸ
                        const illuminance = sensor.illuminance;
                        currentSensorValues.illuminance = illuminance;
                        lightValueEl.textContent = illuminance ? illuminance.toFixed(0) : '-';
                        lightStatusEl.textContent = "ç›£è¦–ä¸­...";
                        lightStatusEl.classList.remove('error', 'not-supported');
                        if (illuminance === null || typeof illuminance === 'undefined') { /* ... */ }
                        else if (illuminance > 100) { lightIconSun.style.display = 'inline-block'; lightIconMoon.style.display = 'none'; }
                        else if (illuminance < 10) { lightIconSun.style.display = 'none'; lightIconMoon.style.display = 'inline-block'; }
                        else { lightIconSun.style.display = 'none'; lightIconMoon.style.display = 'none'; }
                        if (sensorsInitialized) updateRecordingButtonState();
                    });
                    sensor.addEventListener('error', event => { /* ... */ if (sensorsInitialized) updateRecordingButtonState(); });
                    sensor.start();
                } catch (error) { /* ... */ if (sensorsInitialized) updateRecordingButtonState(); }
            };
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'ambient-light-sensor' })
                    .then(permissionStatus => {
                        if (permissionStatus.state === 'granted') startSensor();
                        else if (permissionStatus.state === 'prompt') lightStatusEl.textContent = 'å…‰ã‚»ãƒ³ã‚µãƒ¼: ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚';
                        else { lightStatusEl.textContent = 'å…‰ã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚'; lightStatusEl.classList.add('error'); }
                        permissionStatus.onchange = () => { /* ... */ if (sensorsInitialized) updateRecordingButtonState(); };
                        if (sensorsInitialized && permissionStatus.state !== 'granted') updateRecordingButtonState();
                    })
                    .catch(e => { startSensor(); });
            } else { startSensor(); }
        }

        // --- Recording Logic ---
        function recordCurrentData() { /* ... (å¤‰æ›´ãªã—) ... */ }
        function startRecording() {
            if (!sensorsInitialized || (!anySensorSupported && !motionPermissionGranted && !orientationPermissionGranted)) {
                alert("åˆ©ç”¨å¯èƒ½ãªã‚»ãƒ³ã‚µãƒ¼ãŒãªã„ã‹ã€ã‚»ãƒ³ã‚µãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            isRecording = true; recordedData = [];
            if (recordingIntervalId) clearInterval(recordingIntervalId);
            recordingIntervalId = setInterval(recordCurrentData, RECORDING_INTERVAL_MS);
            updateRecordingButtonState();
        }
        function stopRecording() { /* ... (å¤‰æ›´ãªã—ã€æœ€å¾Œã« updateRecordingButtonState() ) ... */
            isRecording = false;
            if (recordingIntervalId) { clearInterval(recordingIntervalId); recordingIntervalId = null; }
            updateRecordingButtonState();
        }
        function downloadCSV() { /* ... (å¤‰æ›´ãªã—ã€æœ€å¾Œã« updateRecordingButtonState() ã®å‘¼ã³å‡ºã—ã¯ä¸è¦ã‹ã‚‚) ... */ }

        // Event Listeners for Recording Controls
        if(startRecordingIconButton) startRecordingIconButton.addEventListener('click', startRecording);
        if(stopRecordingIconButton) stopRecordingIconButton.addEventListener('click', stopRecording);
        if(downloadCSVIconButton) downloadCSVIconButton.addEventListener('click', downloadCSV);

        // Initial button state
        updateRecordingButtonState();
    </script>
</body>
</html>